<!DOCTYPE html>
<html>
<head>
<title>WELCOME TO AJAX</title>
<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" href="style.css" />
<link rel="stylesheet" href="guest.css" type="text/css" media="screen" />
<style type="text/css">
input.error, textarea.error {
	border: 1px solid orange;
}

label.error {
	margin-left: 10px;
	color: orange;
}
</style>
<script src="./js/httpRequest.js" type="text/javascript"></script>

<!--
<script src="guest.js" type="text/javascript"></script>
-->
<script type="text/javascript">
	/*%%%%%%%%%%%%%%%%%%%%%%%응답도착했을시실행되는콜백함수%%%%%%%%%%%%%%%%%%%%%%%*/
	/****************guest_list[HTML]콜백함수******************/
	function displayGuestListHTML() {
		if (xhr.readyState == 4) {
			if (xhr.status == 200) {
				document.getElementById('guest_list').innerHTML=xhr.responseText;
				/*
				<div class="guest_item">
						<h3 class="guest_title"  guest_no="126">
							<a href=''>타이틀[HTML]</a>
						</h3>
				</div>
				 */
				
			}else if(xhr.status==404){
				alert('404 애러발생!!!');
			}
			showLoadingDialog(false);
		}
	}
	/****************guest_list[JSON]콜백함수******************/
	function displayGuestListJSON() {
		if (xhr.readyState == 4) {
			if (xhr.status == 200) {
				var guestListJsonArray = JSON.parse(xhr.responseText);
				for (var i = 0; i < guestListJsonArray.length; i++) {
					console.log(guestListJsonArray[i]);
				}
				/*
				<<< JSON >>>>
				[
					{
						"guest_no": "126",
						"guest_name": "김호기",
						"guest_date": "2021-04-14",
						"guest_email": "이메일",
						"guest_title": "타이틀",
						"guest_content": "컨텐트"
					},
					{}
				]
				
				<<< HTML >>>
				<div class="guest_item">
						<h3 class="guest_title"  guest_no="126">
							<a href=''>타이틀[JSON]</a>
						</h3>
				</div>
				 */

			}

		}

	}
	/****************guest_list[XML]콜백함수******************/
	function displayGuestListXML() {
		if (xhr.readyState == 4) {
			if (xhr.status == 200) {
				var xmlDoc = xhr.responseXML;
				var guestNodeList = xmlDoc.getElementsByTagName('guest');
				for(var i=0;i<guestNodeList.length;i++){
					var guestE = guestNodeList.item(i);
					console.log(guestE);
				}
				/*
				<<< XML >>
				<guest_list>
					<guest>
						<guest_no>126</guest_no>
						<guest_name>김호기</guest_name>
						<guest_date>2021-04-14 18:20:29</guest_date>
						<guest_email>d</guest_email>
						<guest_homepage>df</guest_homepage>
						<guest_title>dfd</guest_title>
						<guest_content>d</guest_content>
					</guest>
					<guest>..</guest>
				</guest_list>
				
				
				<<< HTML >>>
				<div class="guest_item">
						<h3 class="guest_title"  guest_no="126">
							<a href=''>타이틀[XML]</a>
						</h3>
				</div>
				 */

			}
			showLoadingDialog(false);
		}
	}
	/****************guest_insert_form[HTML]콜백함수******************/
	function displayGuestInsertForm() {
		if (xhr.readyState == 4) {
			document.getElementById('guest_list').innerHTML=xhr.responseText;
			showLoadingDialog(false);
		}
		
	}
	/****************guest_detail[JSON]콜백함수******************/
	function displayGuestDetailJSON(element) {

	}
	/****************guest_detail[XML]콜백함수******************/
	function displayGuestDetailXML(element) {

	}
	/****************guest_detail[HTML]콜백함수******************/
	function displayGuestDetailHTML(element) {
		/*
		element--> h3
		 */
		if (xhr.readyState == 4) {
			if (xhr.status == 200) {
				
				var divE = document.createElement('div');
				divE.setAttribute('class','guest_detail');
				divE.style.display='block';
				
				divE.innerHTML=xhr.responseText;
				element.parentElement.appendChild(divE);
				
				/*
				
					<div class="guest_date">
						날짜:2021-04-14 18:20:29
					</div>
					<div class="guest_name">
						이름:김호기
					</div>
					<div class="guest_email">
						이메일:d
					</div>
					<div class="guest_homepage">
						홈페이지:df
					</div>
					<div class="guest_content">
						내용:d
					</div>
					<div class='guest_delete'>
						<input type="button" value="삭제" guest_no="126">
						<input type="button" value="수정" guest_no="126">
					</div>
				
						...
				 */

				/*
				<div class="guest_item">
					<h3 class="guest_title"  guest_no="2">
						<a href=''>springTest11111[HTML]</a>
					</h3>
					<div class='guest_detail'>
						<div class="guest_date">
							날짜:2020-03-17 18:04:47
						</div>
						<div class="guest_name">
							이름:김경호
						</div>
						..
					</div>
				</div>
				 */
			}
		}

	}

	/****************guest_insert_action[text]콜백함수******************/
	function displayGuestInsertAction() {
		if (xhr.readyState == 4) {
			if (xhr.status == 200) {
				var recvText = xhr.responseText;
				if(recvText.trim()=='true'){
					 document.getElementById('guest_list').innerHTML='';
					 sendRequest('guest/guest_list_html.jsp',null,displayGuestListHTML,'GET');
				}else{
					 alert('쓰기실패!!');
				}
			}

		}
	}
	/****************guest_logout_action[text]콜백함수*****************/
	function displayGuestLogoutAction() {
		if (xhr.readyState == 4) {
			if (xhr.status == 200) {
			}
		}
	}
	/****************guest_login_action[text]콜백함수******************/
	function displayGuestLoginAction() {
		if (xhr.readyState == 4) {
			if (xhr.status == 200) {

			}
		}
	}
    
	/*%%%%%%%%%%%%%%%%%%%%%%%메뉴 UI이벤트처리%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%*/
	window.onload = function(){
		loading_ui_event();
		init();
	};
	
	function init(){
		sendRequest('guest/guest_list_html.jsp',null,displayGuestListHTML,'GET');
	}
	function loading_ui_event() {
		/**************guest_list[HTML]이벤트*****************/
		document.getElementById('menu-a').getElementsByTagName('a').item(0)
				.addEventListener('click', function(e) {
					//ajax요청
					sendRequest('guest/guest_list_html.jsp',null,displayGuestListHTML,'GET');
					e.preventDefault();
					showLoadingDialog(true);
				});

		/*******************guest_list[JSON]이벤트************/
		document.getElementById('menu-b').getElementsByTagName('a').item(0)
				.addEventListener('click', function(e) {
					//ajax요청
					sendRequest('guest/guest_list_json.jsp',null,displayGuestListJSON,'GET');
					e.preventDefault();
				});
		/*******************guest_list[XML]이벤트*************/
		document.getElementById('menu-c').getElementsByTagName('a').item(0)
				.addEventListener('click', function(e) {
					//ajax요청
					sendRequest('guest/guest_list_xml.jsp',null,displayGuestListXML,'GET');
					e.preventDefault();
				});

		/*******************guest_insert_form[HTML]이벤트*****/
		document.getElementById('menu-d').getElementsByTagName('a').item(0)
				.addEventListener('click', function(e) {
					//ajax요청
					sendRequest('guest_insert_form.html', null,displayGuestInsertForm , 'GET', true);
					showLoadingDialog(true);
				});
	}//onload event end
	/*%%%%%%%%%%%%%%%%%%%%%%%메뉴 UI이벤트처리 끝%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%*/

	/*%%%%%동적으로추가되는 Node 이벤트처리[DOMNodeInserted이벤트]시작%%%%%%*/
	document.addEventListener('DOMNodeInserted',function(e) {
						if (e.target.className == 'guest_detail') {
							/*****방명록 delete 버튼 event등록******/
						} else if (e.target.id == 'guest_write_form') {
							/*****방명록쓰기폼 submit event등록******/
							
							var guestWriteFormE = e.target;
							guestWriteFormE.addEventListener('submit',function(e1){
								//방명록쓰기ajax요청
								var url='guest/guest_insert_action.jsp';
								var params='guest_name='+guestWriteFormE.guest_name.value+'&'+
										   'guest_title='+guestWriteFormE.guest_title.value+'&'+
										   'guest_content='+guestWriteFormE.guest_content.value+'&'+
										   'guest_email='+guestWriteFormE.guest_email.value+'&'+
										   'guest_homepage='+guestWriteFormE.guest_homepage.value;
								
								var callback = displayGuestInsertAction;
								var method='POST';
								var async=true;
								sendRequest(url, params, callback, method, async);
								e1.preventDefault();
							});
						} else if (e.target.tagName == 'DIV'&& e.target.className == 'guest_item') {
							/*****방명록상세보기 a click event등록******/
							var divE = e.target;
							divE.getElementsByTagName('a').item(0).addEventListener('click',function(e2){
								
								if(e2.target.parentNode.parentNode.childElementCount > 1){
									//방명록상세보기ajax요청안함
									if(e2.target.parentNode.parentNode.lastChild.style.display=='block'){
										e2.target.parentNode.parentNode.lastChild.style.display='none';
									}else{
										e2.target.parentNode.parentNode.lastChild.style.display='block';
									}
								}else{
									
									var guest_no=e2.target.parentNode.getAttribute('guest_no');
									if(e2.target.innerHTML.endsWith('[HTML]')){
										//방명록상세보기 ajax요청함[HTML]
										sendRequest('guest/guest_detail_html.jsp','guest_no='+guest_no,function(){
											displayGuestDetailHTML(e2.target.parentElement);
										},'GET',true);
										
									}else if(e2.target.innerHTML.endsWith('[JSON]')){
										//방명록상세보기 ajax요청함[JSON]
										sendRequest('guest/guest_detail_json.jsp','guest_no='+guest_no,function(){
											displayGuestDetailJSON(e2.target.parentElement);
										},'GET',true);
										
									}else if(e2.target.innerHTML.endsWith('[XML]')){
										//방명록상세보기 ajax요청함[XML]
										sendRequest('guest/guest_detail_xml.jsp','guest_no='+guest_no,function(){
											displayGuestDetailXML(e2.target.parentElement);
										},'GET',true);
										
									}
									
									
									
									
									
									
									
								}
								e2.preventDefault();
							});
							/*
							<div class="guest_item">
								<h3 class="guest_title" guest_no="89"><a href="">b[HTML]</a></h3>
							</div>
							 */
						}
					});
	/*%%%%%동적으로추가되는 Node 이벤트처리[DOMNodeInserted이벤트]끝%%%%%%*/
	
	

	/*******loading dialog************/
	function showLoadingDialog(isVisible) {
		if (isVisible) {
			var dialogDivE = document.createElement('div');
			dialogDivE.setAttribute('id', 'loading');
			dialogDivE.innerHTML = 'loading...';
			dialogDivE.style.display = 'block';
			var guestListDivE = document.getElementById('guest_list');
			guestListDivE.parentElement.insertBefore(dialogDivE, guestListDivE);

		} else {
			var loadingDivE = document.getElementById('loading');
			if (loadingDivE != null) {
				loadingDivE.parentElement.removeChild(loadingDivE);
			}
		}
	}
</script>
</head>
<body>
	<div id="container">
		<div id="header">
			<h1>WELCOME TO AJAX</h1>
		</div>
		<div id="sidebar">

			<h2>회원관리메뉴</h2>
			<div class="menus">
				<div class="menu" id="menu-a">
					<h3>
						<a href="test.jsp">방명록 리스트[html]</a>
					</h3>
				</div>
				<div class="menu" id="menu-b">
					<h3>
						<a href="#">방명록 리스트[json]</a>
					</h3>
				</div>
				<div class="menu" id="menu-c">
					<h3>
						<a href="#">방명록 리스트[xml]</a>
					</h3>
				</div>
				<div class="menu" id="menu-d">
					<h3>
						<a href="#">방명록 쓰기</a>
					</h3>
				</div>

				<form id="guest_login_form" method="get" action="vfbfcv">
					<fieldset>
						<legend>로그인</legend>
						<p>
							<label for="guest_id">아이디:</label> <input type="text"
								id="guest_id" name="guest_id" />
						</p>
						<p>
							<label for="guest_pass">패쓰워드:</label> <input type="text"
								name="guest_pass" id="guest_pass" />
						</p>
						<p>
							<input type="submit" name="write" value="로그인" id="write" /> <input
								type="reset" name="cancle" value="취소" id="cancle" />

						</p>
						<div id="msg"></div>
					</fieldset>
				</form>
				<form id="guest_logout_form">
					<div>
						<span id="idSpan"></span>님 로그인<br /> <a id="guest_logout_a"
							href='#'>로그아웃</a>
					</div>
				</form>
			</div>
		</div>
		<div id="content">
			<!--  
			<div id='loading'>loading..</div>
			-->
			<div id="guest_list">

				<!-- 
              
                 -->
			</div>
		</div>
		<div id="footer">
			<p>This page was built for javascript ajax demonstration purposes.</p>
		</div>

	</div>

</body>
</html>
