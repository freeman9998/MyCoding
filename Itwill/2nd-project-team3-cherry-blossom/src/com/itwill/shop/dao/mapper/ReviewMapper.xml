<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.itwill.shop.dao.mapper.ReviewMapper">
	<resultMap  id="ReviewIdResultMap" type="Review" autoMapping="true">
		<association property="userInfo" javaType="UserInfo" autoMapping="true"></association>	
		<association property="product" javaType="Product" autoMapping="true"></association>
	</resultMap>
	<resultMap id="ReviewNoResultMap" type="Review" autoMapping="true">
		<association property="userInfo" javaType="UserInfo" autoMapping="true"></association>
		<association property="product" javaType="Product" autoMapping="true"></association>
	</resultMap>
	<!-- Review select문 -->
	<!-- 리뷰 카운트 -->
	<select id="selectReviewCount" parameterType="int" resultType="int">
		select count(p_no)
		from review
		where p_no = #{product.p_no}
	</select>
	<select id="getReviewCount" resultType="int" >
		select count(*) cnt
		from review
	</select>
	<select id="findReviewList" parameterType="Map" resultType="Review">
		<![CDATA[
		select * from
		(select rownum idx, r.* from
		(select * from review 
		where p_no = #{p_no}
		order by review.r_no desc) r)
		where idx > =#{start} and idx < =#{last}
		]]>
	</select>
	<!-- 리뷰 아이디로 조회 -->
	<select id="selectReview" parameterType="String" resultMap="ReviewIdResultMap">
		select r.user_id, r.p_no, r.r_content, r.r_score
		from review r
		join userinfo u on u.user_id = r.user_id
		where r.user_id =#{userInfo.user_id}
		order by r_no asc
	</select>
	<!-- 리뷰 상품번호로 조회 -->
	<select id="selectReviewN" parameterType="int" resultMap="ReviewNoResultMap" >
		select r.user_id, r.r_content, r.r_score
		from review r
		join product p on p.p_no = r.p_no
		where p.p_no =#{product.p_no}
		order by r_no desc
	</select>
	<!-- 리뷰 별점으로 조회 -->
	<select id="selectReviewStar" parameterType="double" resultType="double">
		select avg(r.r_score)
		from review r
		left outer join product p on p.p_no = r.p_no
		where r.p_no = #{product.p_no}
	</select>
	<!-- 리뷰 유무 체크  -->
	<select id="selectReviewCheck" parameterType="int" resultType="int">
		select count(p_no)
		from review
		where p_no = #{product.p_no}
	</select>
	<!--  리뷰 전체 조회 -->
	<select id="selectReviewAll" parameterType="com.itwill.shop.domain.Review" resultType="Review">
		select r.user_id, r.p_no, r.r_content, r.r_score
		from review r
	</select>
	<!-- Review insert문 -->
	<insert id="insertReview" parameterType="com.itwill.shop.domain.Review">
		
		insert into review(r_no,r_content,r_score,user_id,p_no)
		values (REVIEW_R_NO_SEQ.nextval,#{r_content},#{r_score},#{userInfo.user_id},#{product.p_no})
	</insert>
	
	

</mapper>