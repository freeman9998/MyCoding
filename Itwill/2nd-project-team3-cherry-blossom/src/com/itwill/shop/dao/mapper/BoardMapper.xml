<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.itwill.shop.dao.mapper.BoardMapper">

	<resultMap  id="boardNoticeResultMap" type="Board" autoMapping="true">
			<association property="userInfo" javaType="UserInfo" autoMapping="true"></association>	
	</resultMap>
	
	<resultMap  id="boardQAResultMap" type="Board" autoMapping="true">
			<association property="userInfo" javaType="UserInfo" autoMapping="true"></association>	
			<association property="product" javaType="Product" autoMapping="true"></association>	
	</resultMap>
	
<!-- SELECT -->
	<!--  게시판 공지사항 전체조회  -->
	<select id="boardNoticeSelectAll" resultType="Board" resultMap="boardNoticeResultMap" >
		select b.b_no , b.b_category , b.b_title , b.b_content , b.b_date , b.b_count , b.b_groupno , b.b_step , b.b_depth,u.user_id 
		from board b
		left outer join userinfo u 
		on b.user_id = u.user_id 
		where b_category like '%공지사항%'
		order by b_no desc
	</select>
	
	<!-- 게시판 상품문의 전체조회 -->
	<select id="boardQASelectAll" resultType="Board" resultMap="boardQAResultMap">
		select b.b_no , b.b_category , b.b_title , b.b_content , b.b_date , b.b_count , b.b_groupno , b.b_step , b.b_depth ,u.user_id,p.p_no,p.p_name
		from board b 
		left outer join userinfo u on b.user_id = u.user_id 
		left outer join product p on b.p_no=p.p_no
		where b_category like '%상품문의%' order by b_no desc
	</select>
	<!--  게시판 1개 조회 -->
	<select id="boardSelectOne" parameterType="int" resultMap="boardQAResultMap">
		select b.b_no,b.b_category,b.b_title,b.b_content,b.b_date,b.b_count,b.b_groupno,b.b_step,b.b_depth,u.user_id,p.p_no,p.p_name
		from board b left outer join userinfo u on b.user_id = u.user_id 
		left outer join product p on b.p_no = p.p_no
		where b.b_no =#{b_no}
	</select>
	<!-- 공지 게시판 페이지 조회 -->
	<select id="selectBoardNoticeAll" resultType="Board" resultMap="boardNoticeResultMap" parameterType="map">
		select * from
			(select rownum idx, s.*  from
	            (select b.b_no,b.b_category, b.b_title,b.b_date, b.b_count,b.b_groupno, b.b_step, b.b_depth, u.user_id  
	             from board b
                 left outer join userinfo u
                 on b.user_id = u.user_id
                 where b_category like '%공지%'
	             order by b_no desc ) s )
			where idx &gt;=#{start} and idx &lt;=#{last}
	</select>
	<!-- 상품 게시판 페이지 조회 -->
	<select id="selectBoardQA_All" resultType="Board" resultMap="boardQAResultMap" parameterType="map">
		select * from
			(select rownum idx, s.*  from
	            (select b.b_no,b.b_category, b.b_title,b.b_date, b.b_count,b.b_groupno, b.b_step, b.b_depth, u.user_id , p.p_no , p.p_name 
	             from board b
                 left outer join userinfo u
                 on b.user_id = u.user_id
                 left outer join product p
                 on b.p_no = p.p_no
                 where b_category like '%상품%'
	             order by b_groupno desc, b_step asc ) s )
			where idx &gt;=#{startNo} and idx &lt;=#{endNo}
	</select>	
	<!-- 게시물 총 건수를 조회  -->
	<select id="selectCategoryCount" resultType="int">
		 select count(b_category) from board where b_category like '%공지%'
	</select>
<!-- insert -->	

	<!-- 상품문의 게시글 쓰기 -->
	<insert id="insertBoardQA" parameterType="Board" >
		insert into board (b_no,b_category,b_title,b_content,b_date,b_count,b_groupNo,b_step,b_depth,user_id,p_no)
		values(
		board_b_no_SEQ.nextval,
		#{b_category},
		#{b_title},
		#{b_content},
		#{b_date},
		#{b_count},
		board_b_no_SEQ.currval,
		1,
		0,
		#{userInfo.user_id},
		#{product.p_no}
		)
	</insert>
	
	<!-- 상품문의 댓글  -->
	<insert id="insertBoardQR_RE" parameterType="Board">
		insert into board (b_no,b_category,b_title,b_content,b_date,b_count,b_groupno,b_step,b_depth,user_id,p_no)
		VALUES(
		board_b_no_SEQ.nextval,
		#{b_category},
		#{b_title},
		#{b_content},
		sysdate,
		0,
		board_b_no_SEQ.currval,
		#{b_step}+1,
		#{b_depth}+1,
		#{userInfo.user_id},
		#{product.p_no}
		)
	</insert>
	
	<!-- 조회된 게시물 카운트 1 증가 -->
	<update id="updateViewCnt" parameterType="Board" >
	 	update board set b_count = b_count+1 where b_no =#{b_no}
	</update>
</mapper>